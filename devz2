-- Use global so it sticks between script runs
getgenv().lastDupeTime = getgenv().lastDupeTime or 0
local cooldownTime = 30
local StarterGui = game:GetService("StarterGui")

-- FreeFallMethod loop
task.spawn(function()
    while task.wait() do
        if getgenv().FreeFallMethod then
            local player = game:GetService("Players").LocalPlayer
            if player and player.Character and player.Character:FindFirstChild("Humanoid") then
                player.Character.Humanoid:ChangeState(Enum.HumanoidStateType.Freefall)
            end
        end
    end
end)

-- Auto-run dupe attempt once
task.spawn(function()
    local currentTime = os.time()

    if currentTime - getgenv().lastDupeTime < cooldownTime then
        local timeLeft = cooldownTime - (currentTime - getgenv().lastDupeTime)
        StarterGui:SetCore("SendNotification", {
            Title = "Cooldown Active",
            Text = "⏳ Try again in " .. timeLeft .. " seconds",
            Duration = 5
        })
        return
    end

    getgenv().lastDupeTime = os.time()
    getgenv().FreeFallMethod = true
    task.wait(0.8)

    local Players = game:GetService("Players")
    local ReplicatedStorage = game:GetService("ReplicatedStorage")
    local Workspace = game:GetService("Workspace")

    local function GetCharacter()
        return Players.LocalPlayer and Players.LocalPlayer.Character
    end

    local function BypassTp(targetCFrame)
        local character = GetCharacter()
        if character and character:FindFirstChild("HumanoidRootPart") then
            character.HumanoidRootPart.CFrame = targetCFrame + Vector3.new(2, 0, 0)
        end
    end

    local InventoryRemote = ReplicatedStorage:WaitForChild("Inventory")
    local BackpackRemote = ReplicatedStorage:WaitForChild("BackpackRemote")
    local character = GetCharacter()

    if character and character:FindFirstChildOfClass("Tool") then
        local gunTool = character:FindFirstChildOfClass("Tool")
        local gunName = gunTool.Name

        local humanoid = character:FindFirstChildOfClass("Humanoid")
        if humanoid then humanoid:UnequipTools() end

        local safe = Workspace:FindFirstChild("1# Map") 
                  and Workspace["1# Map"]:FindFirstChild("2 Crosswalks") 
                  and Workspace["1# Map"]["2 Crosswalks"].Safes:GetChildren()[5]

        if not safe then
            getgenv().FreeFallMethod = false
            StarterGui:SetCore("SendNotification", {
                Title = "Dupe Failed",
                Text = "❌ Safe not found!",
                Duration = 5
            })
            return
        end

        local oldCFrame = character:FindFirstChild("HumanoidRootPart") and character.HumanoidRootPart.CFrame

        BypassTp(safe.Union.CFrame)
        task.wait(0.5)

        task.spawn(function()
            BackpackRemote:InvokeServer("Store", gunName)
        end)

        task.spawn(function()
            InventoryRemote:FireServer("Change", gunName, "Backpack", safe)
        end)

        task.wait(0.5)

        if oldCFrame then BypassTp(oldCFrame) end

        task.wait(1.2)

        BackpackRemote:InvokeServer("Grab", gunName)

        task.wait(0.5)

        if oldCFrame then BypassTp(oldCFrame) end

        getgenv().FreeFallMethod = false
        StarterGui:SetCore("SendNotification", {
            Title = "Dupe Successful",
            Text = "✅ Dupe finished!",
            Duration = 5
        })
    else
        getgenv().FreeFallMethod = false
        StarterGui:SetCore("SendNotification", {
            Title = "Dupe Failed",
            Text = "No tool found to dupe!",
            Duration = 5
        })
    end
end)
